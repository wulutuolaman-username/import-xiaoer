from .å°„çº¿æ³• import å¤šç‚¹åœ¨é¢å†…
from .é¢ç§¯æ³• import ç›¸äº¤é¢ç§¯
from .åˆ¤æ–­é€æ˜ import åˆ¤æ–­é€æ˜
from ...é€šç”¨.ä¿¡æ¯ import æŠ¥å‘Šä¿¡æ¯
import bpy, time
import numpy as np
from collections import defaultdict
from concurrent.futures import ThreadPoolExecutor
from ...åå¥½.åå¥½è®¾ç½® import XiaoerAddonPreferences
from ...æŒ‡é’ˆ import XiaoerMaterial

# ç”¨é›†åˆåˆ†åˆ«æ”¶é›†æè´¨é¢åœ¨UVä¸Šçš„ç‚¹åæ ‡å’Œè´´å›¾é€æ˜åƒç´ åœ¨UVä¸Šçš„ç‚¹åæ ‡ï¼Œæœ€åé€šè¿‡ä¸¤ä¸ªé›†åˆçš„äº¤é›†åˆ¤æ–­é€æ˜
æè´¨é¢åƒç´ ç‚¹ = defaultdict(set)
åƒç´ é¢ç´¢å¼• = defaultdict(set)
ä¸Šæ¬¡æ£€æµ‹ = None

def é€šè¿‡UVå’Œåƒç´ æ£€æµ‹é€æ˜æè´¨(self:bpy.types.Operator, åå¥½:XiaoerAddonPreferences, æè´¨, å›¾åƒ, é€æ˜è´´å›¾, æè´¨é¢):
    if é€æ˜è´´å›¾ and å›¾åƒ in é€æ˜è´´å›¾:
        é€æ˜åƒç´ ç‚¹ = é€æ˜è´´å›¾[å›¾åƒ][0]  # alpha < 250
        å®Œå…¨é€æ˜åƒç´ ç‚¹ = é€æ˜è´´å›¾[å›¾åƒ][1]  # alpha < 20
        # print(å›¾åƒ.name, é€æ˜åƒç´ ç‚¹)
        é¢æ•°æ® = æè´¨é¢[æè´¨]
        if é€æ˜åƒç´ ç‚¹ and é¢æ•°æ®:
            def å¤„ç†æ¯ä¸ªé¢(é¢é¡¶ç‚¹):
                é¢é¡¶ç‚¹ = np.array(é¢é¡¶ç‚¹)
                é¢é¡¶ç‚¹ *= åå¥½.æ£€æµ‹é€æ˜åˆ†è¾¨ç‡  # å˜æˆåƒç´ ç©ºé—´åæ ‡

                min_u = int(np.floor(é¢é¡¶ç‚¹[:, 0].min()))
                max_u = int(np.ceil(é¢é¡¶ç‚¹[:, 0].max()))
                min_v = int(np.floor(é¢é¡¶ç‚¹[:, 1].min()))
                max_v = int(np.ceil(é¢é¡¶ç‚¹[:, 1].max()))

                # å‡†å¤‡åƒç´ ä¸­å¿ƒç‚¹
                xv, yv = np.meshgrid(np.arange(min_u, max_u + 1), np.arange(min_v, max_v + 1))
                åƒç´ ç‚¹ = np.stack([(xv + 0.5).ravel(), (yv + 0.5).ravel()], axis=-1)  # +0.5ä»åƒç´ å·¦ä¸‹è§’ç§»åˆ°åƒç´ ä¸­å¿ƒ
                åœ¨å†… = None
                if åå¥½.æ£€æµ‹æ–¹å¼ == 'å°„çº¿':
                    åœ¨å†… = å¤šç‚¹åœ¨é¢å†…(åƒç´ ç‚¹, é¢é¡¶ç‚¹)
                if åå¥½.æ£€æµ‹æ–¹å¼ == 'é¢ç§¯':
                    # â€”â€” æ‰¹é‡è®¡ç®—â€œåƒç´ æ–¹å½¢ âˆ© é¢â€çš„é¢ç§¯ â€”â€” #
                    é¢ç§¯æ•°ç»„ = ç›¸äº¤é¢ç§¯(åƒç´ ç‚¹, é¢é¡¶ç‚¹)
                    # â€”â€” è¿‡æ»¤é¢ç§¯>0 çš„åƒç´ ï¼Œå¾—åˆ°æ•´æ•°åƒç´ åæ ‡é›†åˆ â€”â€” #
                    åœ¨å†… = é¢ç§¯æ•°ç»„ > 1e-12  # æ•°å€¼é˜ˆå€¼ï¼Œé¿å…æµ®ç‚¹å™ªå£°
                # æå–è¢«å‘½ä¸­çš„åŸå§‹æ•´æ•°åƒç´ åæ ‡ï¼ˆç”¨ .ravel() å±•å¹³ï¼‰
                å‘½ä¸­_x = xv.ravel()[åœ¨å†…]
                å‘½ä¸­_y = yv.ravel()[åœ¨å†…]
                åƒç´ ç‚¹ = set(zip(å‘½ä¸­_x, å‘½ä¸­_y))  # è½¬ä¸º set
                return åƒç´ ç‚¹

            é¢åƒç´ ç‚¹ = set()
            global ä¸Šæ¬¡æ£€æµ‹  # å£°æ˜è¦ä¿®æ”¹å…¨å±€å˜é‡
            if æè´¨é¢åƒç´ ç‚¹[æè´¨] and ä¸Šæ¬¡æ£€æµ‹ == åå¥½.æ£€æµ‹æ–¹å¼:
                é¢åƒç´ ç‚¹ = æè´¨é¢åƒç´ ç‚¹[æè´¨]
            else:
                ä¸Šæ¬¡æ£€æµ‹ = åå¥½.æ£€æµ‹æ–¹å¼
                # print(æè´¨, 'æè´¨é¢æ•°é‡ï¼š', len(æè´¨é¢é¡¶ç‚¹[æè´¨]), datetime.datetime.now())
                èµ·å§‹ = time.perf_counter()
                with ThreadPoolExecutor(max_workers=len(é¢æ•°æ®)) as æ‰§è¡Œå™¨:
                    åŒ¹é…ä»»åŠ¡ = [æ‰§è¡Œå™¨.submit(å¤„ç†æ¯ä¸ªé¢, é¢é¡¶ç‚¹) for é¢é¡¶ç‚¹ in é¢æ•°æ®]
                    for ä»»åŠ¡ in åŒ¹é…ä»»åŠ¡:
                        åƒç´ ç‚¹ = ä»»åŠ¡.result()
                        é¢åƒç´ ç‚¹.update(åƒç´ ç‚¹)
                    æè´¨é¢åƒç´ ç‚¹[æè´¨] = é¢åƒç´ ç‚¹
                    ç»ˆæ­¢ = time.perf_counter()
                æŠ¥å‘Šä¿¡æ¯(self, 'æ­£å¸¸', f'ğŸ• æè´¨Material["{æè´¨.name}"]åœ¨æ£€æµ‹é€æ˜å‰åˆ†ææè´¨é¢UVåŒºåŸŸåƒç´ ç”¨æ—¶ï¼š{ç»ˆæ­¢ - èµ·å§‹:.6f} ç§’')
            return é¢åƒç´ ç‚¹, é€æ˜åƒç´ ç‚¹, å®Œå…¨é€æ˜åƒç´ ç‚¹
    return None, None, None, None

def æè´¨UVåŒ…å«é€æ˜åƒç´ (self:bpy.types.Operator, åå¥½:XiaoerAddonPreferences, æ¨¡å‹, æè´¨:XiaoerMaterial, å›¾åƒ, é€æ˜è´´å›¾, æè´¨é¢):
    if åå¥½.æ£€æµ‹é€æ˜æè´¨:
        æè´¨.å°äºŒé¢„è®¾æ¨¡æ¿.ä½¿ç”¨æ£€æµ‹é€æ˜æè´¨ = True
        é¢åƒç´ ç‚¹, é€æ˜åƒç´ ç‚¹, å®Œå…¨é€æ˜åƒç´ ç‚¹ = é€šè¿‡UVå’Œåƒç´ æ£€æµ‹é€æ˜æè´¨(self, åå¥½, æè´¨, å›¾åƒ, é€æ˜è´´å›¾, æè´¨é¢)
        if é€æ˜åƒç´ ç‚¹ and é¢åƒç´ ç‚¹:
            if åˆ¤æ–­é€æ˜(self, æè´¨, å›¾åƒ, é¢åƒç´ ç‚¹, é€æ˜åƒç´ ç‚¹, å®Œå…¨é€æ˜åƒç´ ç‚¹):
                æè´¨.å°äºŒé¢„è®¾æ¨¡æ¿.æ£€æµ‹ç»“æœ = True
                return True
    return False